<?xml version="1.0" encoding="UTF-8"?>
<project name="ancestris-tasks" basedir=".." >
    <target name="-manifest-prep">
        <exec executable="svn" failonerror="false"
              outputproperty="buildversion" errorproperty="svnerror">
                  <arg value="info"/>
            <arg value="--xml"/>
        </exec>
        <xmlproperty>
            <propertyresource name="buildversion"/>
        </xmlproperty>
        <property name="buildnumber" value="${info.entry.commit(revision)}" />
        <parsemanifest manifest="${manifest.mf}" attribute="OpenIDE-Module-Specification-Version" property="spec.version"/>
        <tempfile property="manifest.mf-temp" destDir="build" suffix="MF"/>
        <copy file="${manifest.mf}" tofile="${manifest.mf-temp}"/>
        <manifest file="${manifest.mf-temp}" mode="update">
          <attribute name="OpenIDE-Module-Specification-Version" value="${spec.version}.${buildnumber}"/>
        </manifest>
    </target>
    <target name="jar" depends="init,compile,-manifest-prep,jar-prep" unless="is.jar.uptodate">
        <copyfile src="${manifest.mf-temp}" dest="/tmp/manifest"/>
        <!-- XXX it seems that using <manifest> forces the JAR to be recreated each time -->
        <!-- (presumably due to the variable OIDE-M-I-V) -->
        <!-- so might have to use e.g. <manifest> task (created in build/ somewhere)? -->
        <!-- Cf: http://issues.apache.org/bugzilla/show_bug.cgi?id=29085 -->
        <!-- This task adds some or all of: -Public-Packages, -Friends, Class-Path, -IDE-Dependencies, -Module-Dependencies, -Specification-Version, -Implementation-Version, -Build-Version, AutoUpdate-Show-In-Client -->
        <jarwithmoduleattributes jarfile="${cluster}/${module.jar}" compress="${build.package.compress}" index="${build.package.index}" manifest="${manifest.mf-temp}" stamp="${cluster}/.lastModified">
            <fileset dir="${build.classes.dir}"/>
        </jarwithmoduleattributes>
    </target>
</project>