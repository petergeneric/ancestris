package ancestris.modules.releve.editor;

import ancestris.modules.releve.model.Field;
import ancestris.modules.releve.model.FieldDate;
import genj.gedcom.GedcomException;
import genj.gedcom.PropertyDate;
import genj.gedcom.time.Calendar;
import genj.gedcom.time.PointInTime;
import genj.util.swing.DateWidget;
import genj.util.swing.NestedBlockLayout;
import java.awt.event.ActionEvent;
import java.awt.event.KeyEvent;
import javax.swing.AbstractAction;
import javax.swing.JComponent;
import javax.swing.JTextField;
import javax.swing.KeyStroke;
import org.openide.util.Exceptions;



/**
 * Remarque : remplace genj.edit.beans.SimpleValueBean a laquelle il manque
 * dans le constructeur "defaultFocus = tfield;"
 * @author Michel
 */
public class BeanDate extends Bean {

    //private final static ImageIcon PIT = new ImageIcon(PropertyBean.class, "/genj/gedcom/images/Time");
    private final static NestedBlockLayout H = new NestedBlockLayout("<row><choose/><date1/><label2/><date2/><phrase/></row>");
    private final static NestedBlockLayout V = new NestedBlockLayout("<table><row><choose/><date1/></row><row><label2/><date2/></row><row><phrase cols=\"2\"/></row></table>");
    private DateWidget dateWidget;
    private Calendar preferedCalendar = PointInTime.GREGORIAN;
  

    public BeanDate() {
        setLayout(V.copy());
        setAlignmentX(0);

        // .. first date
        dateWidget = new DateWidget();
        dateWidget.addChangeListener(changeSupport);
        add(dateWidget);

        // do the layout and format
        setPreferHorizontal(false);
        //setFormat(PropertyDate.FORMATS[0]);
        setPreferedCalendar(PointInTime.GREGORIAN, PointInTime.FRENCHR);

        // setup default focus
        defaultFocus = dateWidget;

        // je configure le raccourci des touches de direction haut et bas pour increment ou decrementer la date d'un jour
        JComponent date2 = (JComponent) dateWidget.getComponent(0);
        if ( date2 instanceof JTextField) {
            // je desactive les touches haut et pas pour supprimer l'action du scrollbar parent
            date2.getInputMap(JComponent.WHEN_FOCUSED).remove( KeyStroke.getKeyStroke(KeyEvent.VK_UP, 0));
            date2.getInputMap(JComponent.WHEN_FOCUSED).remove( KeyStroke.getKeyStroke(KeyEvent.VK_DOWN, 0));
            // j'associe les touches et les actions
            date2.getInputMap(JComponent.WHEN_FOCUSED).put( KeyStroke.getKeyStroke(KeyEvent.VK_UP, 0), "Increase");
            date2.getInputMap(JComponent.WHEN_FOCUSED).put( KeyStroke.getKeyStroke(KeyEvent.VK_DOWN, 0), "Decrease");
            // j'ajoute les nouvelles actions
            date2.getActionMap().put("Increase", new AbstractAction() {
                @Override
                public void actionPerformed(ActionEvent actionEvent) {
                    // j'incremente la valeur
                    dateWidget.setValue(dateWidget.getValue().add(1, 0, 0));
                }
            });

            date2.getActionMap().put("Decrease", new AbstractAction() {
                @Override
                public void actionPerformed(ActionEvent actionEvent) {
                    // je decremente la valeur
                    dateWidget.setValue(dateWidget.getValue().add(-1, 0, 0));
                }
            });
        }
     
    }

    public final void setPreferedCalendar(Calendar prefered, Calendar alternate) {
        preferedCalendar = prefered;
        dateWidget.setPreferedCalendar(prefered, alternate);
        //date2.setPreferedCalendar(prefered, alternate);
        
    }

    public final void setPreferHorizontal(boolean set) {

        setLayout(set ? H.copy() : V.copy());
        //PropertyDate.Format f = format;
        //format = null;
        //setFormat(f);

        revalidate();
        repaint();
    }

    /**
     * Set context to edit
     */
    @Override
    public void setFieldImpl() {
        FieldDate fieldDate = (FieldDate) getField();
        PropertyDate prop = null;
        if( fieldDate != null) {
            prop = fieldDate.getPropertyDate();
        }
        PointInTime pit;
        if (prop == null) {
            pit = new PointInTime();
        } else {
            pit = prop.getStart();            
            if (pit.getCalendar() != preferedCalendar) {
                try {
                    pit = pit.getPointInTime(preferedCalendar);
                } catch (GedcomException ex) {
                    // si ce n'est pas convertible, j'affiche la date avec son calendrier
                    //Exceptions.printStackTrace(ex);
                }
            }
        }
        dateWidget.setValue(pit);
    }

    @Override
    protected void replaceValueImpl(Field field) {
        FieldDate fieldDate = (FieldDate) field;
        PropertyDate prop = null;
        if( fieldDate != null) {
            prop = fieldDate.getPropertyDate();
        }
        PointInTime pit;
        if (prop == null) {
            pit = new PointInTime();
        } else {
            pit = prop.getStart();            
            if (pit.getCalendar() != preferedCalendar) {
                try {
                    pit = pit.getPointInTime(preferedCalendar);
                } catch (GedcomException ex) {
                    // si ce n'est pas convertible, j'affiche la date avec son calendrier
                    //Exceptions.printStackTrace(ex);
                }
            }
        }
        dateWidget.setValue(pit);
        
        // je s√©lectionne le texte contenu dans le premier champ de la date
        if (dateWidget.getComponent(0) != null  && dateWidget.getComponent(0) instanceof JTextField) {
            ((JTextField)dateWidget.getComponent(0)).selectAll();
        }
    }


    /**
     * Finish editing a property through proxy
     */
    @Override
    protected void commitImpl() {        
        String result;
        PointInTime pit = dateWidget.getValue();
        if( pit != null) {
            if( dateWidget.getCalendar() != PointInTime.GREGORIAN) {
                // je convertis la  date dans le calendrier GREGORIAN
                try {
                    pit =  pit.getPointInTime(PointInTime.GREGORIAN);
                } catch (GedcomException ex) {
                    Exceptions.printStackTrace(ex);
                    return;
                }
            } 
            
            int  day2 = pit.getDay();
            int month2 = pit.getMonth();        
            int  year2 = pit.getYear();   
            if ( year2 == PointInTime.UNKNOWN ) {
                result = "";
            } else if (month2 == PointInTime.UNKNOWN  ) {
                result = String.format("%04d", year2);
            } else if (day2 == PointInTime.UNKNOWN) {
                result = String.format("%02d/%04d", month2 +1 , year2);
            } else {
                result = String.format("%02d/%02d/%04d", day2 +1 , month2+1 , year2);
            }
        } else {
            result = "";
        }
        
        setFieldValue(result);

    }

}
