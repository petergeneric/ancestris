package ancestris.modules.editors.genealogyeditor.panels;

import ancestris.modules.editors.genealogyeditor.models.NameTypeComboBoxModel;
import genj.gedcom.*;
import java.util.ArrayList;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import org.jdesktop.swingx.autocomplete.AutoCompleteDecorator;

/**
 *
 * @author dominique
 */
public class NameEditorPanel extends javax.swing.JPanel {

    private NameTypeComboBoxModel nameTypeComboBoxModelModel = new NameTypeComboBoxModel();
    private Indi root;
    private PropertyName name;
    private boolean nameTypeModified;
    private boolean familyNamePrefixModified;
    private boolean familyNameModified;
    private boolean firstNamePrefixModified;
    private boolean firstNameSuffixModified;
    private boolean firstNameModified;
    private boolean nicknameModified;
    private final static Logger logger = Logger.getLogger(NameEditorPanel.class.getName(), null);

    /**
     * Creates new form NameEditorPanel
     */
    public NameEditorPanel() {
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        nameTypeLabel = new javax.swing.JLabel();
        nameTypeComboBox = new javax.swing.JComboBox<String>();
        firstnameLabel = new javax.swing.JLabel();
        firstNamePrefixTextField = new javax.swing.JTextField();
        firstNameTextField = new javax.swing.JTextField();
        familyNameLabel = new javax.swing.JLabel();
        familyNamePrefixTextField = new javax.swing.JTextField();
        familyNameTextField = new javax.swing.JTextField();
        firstNameSuffixTextField = new javax.swing.JTextField();
        nicknameLabel = new javax.swing.JLabel();
        nicknameTextField = new javax.swing.JTextField();

        nameTypeLabel.setText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.nameTypeLabel.text"), new Object[] {})); // NOI18N

        nameTypeComboBox.setEditable(true);
        nameTypeComboBox.setModel(nameTypeComboBoxModelModel);
        nameTypeComboBox.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                nameTypeComboBoxActionPerformed(evt);
            }
        });

        firstnameLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        firstnameLabel.setText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.firstnameLabel.text"), new Object[] {})); // NOI18N

        firstNamePrefixTextField.setColumns(8);
        firstNamePrefixTextField.setHorizontalAlignment(javax.swing.JTextField.LEFT);
        firstNamePrefixTextField.setToolTipText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.firstNamePrefixTextField.toolTipText"), new Object[] {})); // NOI18N
        firstNamePrefixTextField.getDocument().addDocumentListener(new DocumentListener() {

            @Override
            public void changedUpdate(DocumentEvent e) {
                firstNamePrefixModified = true;
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                firstNamePrefixModified = true;
            }

            @Override
            public void insertUpdate(DocumentEvent e) {
                firstNamePrefixModified = true;
            }
        });

        firstNameTextField.setToolTipText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.firstNameTextField.toolTipText"), new Object[] {})); // NOI18N
        firstNameTextField.getDocument().addDocumentListener(new DocumentListener() {

            @Override
            public void changedUpdate(DocumentEvent e) {
                firstNameModified = true;
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                firstNameModified = true;
            }

            @Override
            public void insertUpdate(DocumentEvent e) {
                firstNameModified = true;
            }
        });

        familyNameLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        familyNameLabel.setText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.familyNameLabel.text"), new Object[] {})); // NOI18N

        familyNamePrefixTextField.setColumns(8);
        familyNamePrefixTextField.setToolTipText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.familyNamePrefixTextField.toolTipText"), new Object[] {})); // NOI18N
        familyNamePrefixTextField.getDocument().addDocumentListener(new DocumentListener() {

            @Override
            public void changedUpdate(DocumentEvent e) {
                familyNamePrefixModified = true;
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                familyNamePrefixModified = true;
            }

            @Override
            public void insertUpdate(DocumentEvent e) {
                familyNamePrefixModified = true;
            }
        });

        familyNameTextField.setColumns(16);
        familyNameTextField.setToolTipText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.familyNameTextField.toolTipText"), new Object[] {})); // NOI18N
        familyNameTextField.getDocument().addDocumentListener(new DocumentListener() {

            @Override
            public void changedUpdate(DocumentEvent e) {
                familyNameModified = true;
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                familyNameModified = true;
            }

            @Override
            public void insertUpdate(DocumentEvent e) {
                familyNameModified = true;
            }
        });

        firstNameSuffixTextField.setColumns(8);
        firstNameSuffixTextField.setText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.firstNameSuffixTextField.text"), new Object[] {})); // NOI18N
        firstNameSuffixTextField.setToolTipText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.firstNameSuffixTextField.toolTipText"), new Object[] {})); // NOI18N
        firstNameSuffixTextField.getDocument().addDocumentListener(new DocumentListener() {

            @Override
            public void changedUpdate(DocumentEvent e) {
                firstNameSuffixModified = true;
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                firstNameSuffixModified = true;
            }

            @Override
            public void insertUpdate(DocumentEvent e) {
                firstNameSuffixModified = true;
            }
        });

        nicknameLabel.setHorizontalAlignment(javax.swing.SwingConstants.RIGHT);
        nicknameLabel.setText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.nicknameLabel.text"), new Object[] {})); // NOI18N

        nicknameTextField.setColumns(8);
        nicknameTextField.setHorizontalAlignment(javax.swing.JTextField.LEFT);
        nicknameTextField.setToolTipText(java.text.MessageFormat.format(java.util.ResourceBundle.getBundle("ancestris/modules/editors/genealogyeditor/panels/Bundle").getString("NameEditorPanel.nicknameTextField.toolTipText"), new Object[] {})); // NOI18N
        nicknameTextField.getDocument().addDocumentListener(new DocumentListener() {

            @Override
            public void changedUpdate(DocumentEvent e) {
                nicknameModified = true;
            }

            @Override
            public void removeUpdate(DocumentEvent e) {
                nicknameModified = true;
            }

            @Override
            public void insertUpdate(DocumentEvent e) {
                nicknameModified = true;
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(272, 272, 272)
                        .addComponent(nameTypeLabel)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(nameTypeComboBox, 0, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                    .addGroup(layout.createSequentialGroup()
                        .addContainerGap()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(firstnameLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 120, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(nicknameLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 120, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(familyNameLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 120, javax.swing.GroupLayout.PREFERRED_SIZE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(firstNamePrefixTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                    .addComponent(familyNamePrefixTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addComponent(firstNameTextField)
                                    .addGroup(layout.createSequentialGroup()
                                        .addComponent(familyNameTextField)
                                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                        .addComponent(firstNameSuffixTextField, javax.swing.GroupLayout.PREFERRED_SIZE, 88, javax.swing.GroupLayout.PREFERRED_SIZE))))
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(nicknameTextField)
                                .addGap(133, 133, 133)))))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(nameTypeComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(nameTypeLabel))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(firstNamePrefixTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(firstNameTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(firstnameLabel))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(nicknameTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(nicknameLabel))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(familyNamePrefixTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(familyNameLabel)
                    .addComponent(familyNameTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(firstNameSuffixTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void nameTypeComboBoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_nameTypeComboBoxActionPerformed
        nameTypeModified = true;
    }//GEN-LAST:event_nameTypeComboBoxActionPerformed
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel familyNameLabel;
    private javax.swing.JTextField familyNamePrefixTextField;
    private javax.swing.JTextField familyNameTextField;
    private javax.swing.JTextField firstNamePrefixTextField;
    private javax.swing.JTextField firstNameSuffixTextField;
    private javax.swing.JTextField firstNameTextField;
    private javax.swing.JLabel firstnameLabel;
    private javax.swing.JComboBox<String> nameTypeComboBox;
    private javax.swing.JLabel nameTypeLabel;
    private javax.swing.JLabel nicknameLabel;
    private javax.swing.JTextField nicknameTextField;
    // End of variables declaration//GEN-END:variables

    public void set(Indi root, PropertyName name) {
        this.root = root;
        this.name = name;

        ArrayList<String> firstNames = new ArrayList<String>();
        ArrayList<String> lastNames = new ArrayList<String>();

        for (Indi indi : root.getGedcom().getIndis()) {
            firstNames.add(indi.getFirstName());
            lastNames.add(indi.getLastName());
        }

        AutoCompleteDecorator.decorate(firstNameTextField, firstNames, false);
        AutoCompleteDecorator.decorate(familyNameTextField, lastNames, false);

        String version = root.getGedcom().getGrammar().getVersion();
        if (version.equals("5.5")) {
            nameTypeLabel.setVisible(false);
            nameTypeComboBox.setVisible(false);
        }

        if (name != null) {
            /*
             * Indicates the name type, for example the name issued or assumed
             * as an immigrant.
             */
            Property nameType = name.getProperty("TYPE");
            if (nameType != null) {
                nameTypeComboBox.setSelectedItem(nameType.getValue());
            } else {
                nameTypeComboBox.setSelectedIndex(1);
            }
            nameTypeModified = false;

            /*
             * NPFX Non indexing name piece that appears preceding the given
             * name and surname parts. Different name prefix parts are separated
             * by a comma.
             *
             */
            Property firstnamePrefix = name.getProperty("NPFX");
            firstNamePrefixTextField.setText(firstnamePrefix != null ? firstnamePrefix.getValue() : "");
            firstNamePrefixModified = false;
            
            /*
             * GIVN Given name or earned name. Different given names are
             * separated by a comma.
             */
            Property givenName = name.getProperty("GIVN");
            firstNameTextField.setText(givenName != null ? givenName.getValue() : name.getFirstName());
            firstNameModified = false;

            /*
             * NSFX Non-indexing name piece that appears after the given name
             * and surname parts. Different name suffix parts are separated by a
             * comma.
             */
            Property firstNameSuffix = name.getProperty("NSFX");
            firstNameSuffixTextField.setText(firstNameSuffix != null ? firstNameSuffix.getValue() : "");
            firstNameSuffixModified = false;

            /*
             * SPFX surname prefix or article used in a family name. Different
             * surname articles are separated by a comma, for example in the
             * name "de la Cruz", this value would be "de, la".
             */
            Property familyNamePrefix = name.getProperty("SPFX");
            familyNamePrefixTextField.setText(familyNamePrefix != null ? familyNamePrefix.getValue() : "");
            familyNamePrefixModified = false;

            /*
             * SURN Surname or family name. Different surnames are separated by
             * a comma.
             */
            Property familyName = name.getProperty("SURN");
            if (familyName != null) {
                familyNameTextField.setText(familyName.getValue());
            } else {
                familyNameTextField.setText(name.getLastName());
            }
            familyNameModified = false;

            /*
             * NICK A descriptive or familiar name used in connection with one's
             * proper name.
             */
            Property nickName = name.getProperty("NICK");
            nicknameTextField.setText(nickName != null ? nickName.getValue() : "");
            nicknameModified = false;
        } else {
            nameTypeComboBox.setSelectedIndex(1);
            nameTypeModified = false;
        }
    }

    public void commit() {
        final String version = root.getGedcom().getGrammar().getVersion();

        logger.log(Level.INFO, "Commiting ...");
        try {
            root.getGedcom().doUnitOfWork(new UnitOfWork() {

                @Override
                public void perform(Gedcom gedcom) throws GedcomException {
                    if (name == null) {
                        logger.log(Level.INFO, "Add property NAME");
                        
                        name = (PropertyName) root.addProperty("NAME", "");
                    }

                    if (version.equals("5.5.1") && nameTypeModified == true) {

                        Property nameType = name.getProperty("TYPE");
                        if (nameType == null) {
                            logger.log(Level.INFO, "Add property TYPE");
                            
                            name.addProperty("TYPE", nameTypeComboBox.getSelectedItem().toString());
                        } else {
                            logger.log(Level.INFO, "Update property TYPE");
                            
                            nameType.setValue(nameTypeComboBox.getSelectedItem().toString());
                        }
                    }

                    /*
                     * NPFX Non indexing name piece that appears preceding the
                     * given name and surname parts. Different name prefix parts
                     * are separated by a comma.
                     */
                    if (firstNamePrefixModified == true) {
                        Property firstnamePrefix = name.getProperty("NPFX");
                        if (firstnamePrefix == null) {
                            logger.log(Level.INFO, "Add property NPFX");

                            name.addProperty("NPFX", firstNamePrefixTextField.getText().trim());
                        } else {
                            logger.log(Level.INFO, "Update property NPFX");
                            firstnamePrefix.setValue(firstNamePrefixTextField.getText().trim());
                        }
                    }

                    /*
                     * GIVN Given name or earned name. Different given names are
                     * separated by a comma.
                     */
                    if (firstNameModified == true) {
                        Property givenName = name.getProperty("GIVN");
                        if (givenName == null) {
                            logger.log(Level.INFO, "Add property GIVN");

                            name.addProperty("GIVN", firstNameTextField.getText().trim());
                        } else {
                            logger.log(Level.INFO, "Update property GIVN");
                            givenName.setValue(firstNameTextField.getText().trim());
                        }
                    }

                    if (firstNameSuffixModified == true) {
                        Property firstNameSuffix = name.getProperty("NSFX");
                        if (firstNameSuffix == null) {
                            logger.log(Level.INFO, "Add property NSFX");
                            name.addProperty("NSFX", firstNameSuffixTextField.getText().trim());
                        } else {
                            logger.log(Level.INFO, "Update property NSFX");
                            firstNameSuffix.setValue(firstNameSuffixTextField.getText().trim());
                        }
                    }

                    /*
                     * SPFX surname prefix or article used in a family name.
                     * Different surname articles are separated by a comma, for
                     * example in the name "de la Cruz", this value would be
                     * "de, la".
                     */
                    if (familyNamePrefixModified == true) {
                        Property familyNamePrefix = name.getProperty("SPFX");
                        if (familyNamePrefix == null) {
                            logger.log(Level.INFO, "Add property SPFX");
                            name.addProperty("SPFX", familyNamePrefixTextField.getText().trim());
                        } else {
                            logger.log(Level.INFO, "Update property SPFX");
                            familyNamePrefix.setValue(familyNamePrefixTextField.getText().trim());
                        }
                    }

                    /*
                     * SURN Surname or family name. Different surnames are
                     * separated by a comma.
                     */
                    if (familyNameModified == true) {
                        Property familyName = name.getProperty("SURN");
                        if (familyName == null) {
                            logger.log(Level.INFO, "Add property SURN");
                            name.addProperty("SURN", familyNameTextField.getText().trim());
                        } else {
                            logger.log(Level.INFO, "Update property SURN");
                            familyName.setValue(familyNameTextField.getText().trim());
                        }
                    }

                    if (nicknameModified == true) {
                        Property nickname = name.getProperty("NICK");
                        if (nickname == null) {
                            logger.log(Level.INFO, "Update property NICK");
                            name.addProperty("NICK", nicknameTextField.getText().trim());
                        } else {
                            logger.log(Level.INFO, "Update property NICK");
                            nickname.setValue(nicknameTextField.getText().trim());
                        }
                    }
                }
            }); // end of doUnitOfWork
        } catch (GedcomException ex) {
            logger.log(Level.SEVERE, ex.getMessage());
        }

        logger.log(Level.INFO, "... finished");
    }

    PropertyName get() {
        return name;
    }
}
